<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reference - Tally</title>
    <meta name="description" content="Complete reference for Tally's merchants.rules and views.rules syntax. Match functions, conditions, tags, and filter expressions.">
    <link rel="icon" type="image/svg+xml" href="logo.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Page-specific styles for Reference */
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 3rem 2rem 5rem;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 50%, #16a34a 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            color: rgba(255,255,255,0.6);
            font-size: 1.1rem;
            margin-bottom: 2rem;
        }

        h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #fff;
            margin: 3rem 0 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255,255,255,0.08);
        }

        h2:first-of-type {
            margin-top: 0;
            border-top: none;
            padding-top: 0;
        }

        h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: rgba(255,255,255,0.95);
            margin: 2rem 0 0.75rem;
        }

        p {
            color: rgba(255,255,255,0.8);
            margin-bottom: 1rem;
        }

        pre {
            background: #0d0d0d;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 1rem 1.25rem;
            overflow-x: auto;
            margin: 1rem 0 1.5rem;
        }

        code {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
        }

        pre code {
            color: #e0e0e0;
        }

        p code {
            background: rgba(255,255,255,0.1);
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .comment {
            color: rgba(255,255,255,0.4);
        }

        .highlight {
            color: #4ade80;
        }

        .keyword {
            color: #60a5fa;
        }

        .string {
            color: #fbbf24;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0 1.5rem;
            font-size: 0.9rem;
        }

        th, td {
            text-align: left;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }

        th {
            color: rgba(255,255,255,0.5);
            font-weight: 500;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        td {
            color: rgba(255,255,255,0.8);
        }

        td code {
            background: rgba(255,255,255,0.08);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        ul, ol {
            margin: 1rem 0 1.5rem 1.5rem;
            color: rgba(255,255,255,0.8);
        }

        li {
            margin-bottom: 0.5rem;
        }

        a {
            color: #4ade80;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        h2[id] {
            position: relative;
        }

        h2[id] .anchor-link {
            position: absolute;
            left: -1.5rem;
            color: rgba(255,255,255,0.3);
            text-decoration: none;
            opacity: 0;
            transition: opacity 0.2s;
            font-weight: 400;
        }

        h2[id]:hover .anchor-link {
            opacity: 1;
        }

        h2[id] .anchor-link:hover {
            color: #4ade80;
            text-decoration: none;
        }

        @media (max-width: 768px) {
            h1 { font-size: 2rem; }
            .container { padding: 2rem 1.5rem 3rem; }
            table { font-size: 0.8rem; }
            th, td { padding: 0.5rem; }
        }
    </style>
</head>
<body>
    <nav>
        <div class="nav-inner">
            <a href="index.html" class="nav-logo"><img src="logo.svg" alt="Tally">tally</a>
            <div class="hamburger" onclick="this.classList.toggle('active'); document.querySelector('.nav-links').classList.toggle('active')">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <div class="nav-links">
                <span class="close-menu" onclick="document.querySelector('.nav-links').classList.remove('active'); document.querySelector('.hamburger').classList.remove('active')">&times;</span>
                <a href="quickstart.html">Quick Start</a>
                <a href="guide.html">Guide</a>
                <a href="reference.html" class="active">Reference</a>
                <a href="formats.html">Formats</a>
                <a href="https://github.com/davidfowl/tally" class="mobile-github" style="display:none;">GitHub</a>
            </div>
            <a href="https://github.com/davidfowl/tally" class="nav-github">GitHub</a>
        </div>
    </nav>

    <div class="container">
        <h1>Reference</h1>
        <p class="subtitle">Complete syntax for merchants.rules and views.rules</p>

        <div class="toc">
            <div class="toc-title">Contents</div>
            <div class="toc-columns">
                <div>
                    <a href="#merchants-rules">Merchants Rules</a>
                    <a href="#match-functions">Match Functions</a>
                    <a href="#conditions">Amount &amp; Date Conditions</a>
                    <a href="#combining">Combining Conditions</a>
                    <a href="#custom-fields">Custom CSV Fields</a>
                    <a href="#extraction">Extraction Functions</a>
                    <a href="#rule-mode">Rule Mode (Experimental)</a>
                </div>
                <div>
                    <a href="#variables">Variables</a>
                    <a href="#transforms">Field Transforms</a>
                    <a href="#special-tags">Special Tags</a>
                    <a href="#dynamic-tags">Dynamic Tags</a>
                    <a href="#supplemental">Supplemental Sources (Experimental)</a>
                    <a href="#views-rules">Views Rules</a>
                    <a href="#view-functions">View Functions</a>
                </div>
            </div>
        </div>

        <h2 id="merchants-rules"><a href="#merchants-rules" class="anchor-link">#</a>Merchants Rules</h2>
        <p>File: <code>config/merchants.rules</code></p>
        <p>Categorize transactions by matching descriptions to patterns.</p>

        <h3>Rule Structure</h3>
        <pre><code><span class="highlight">[Rule Name]</span>              <span class="comment"># Display name for matched transactions</span>
<span class="keyword">match:</span> &lt;expression&gt;      <span class="comment"># Required: when to apply this rule</span>
<span class="keyword">category:</span> &lt;Category&gt;     <span class="comment"># Required: primary grouping</span>
<span class="keyword">subcategory:</span> &lt;Sub&gt;       <span class="comment"># Optional: secondary grouping</span>
<span class="keyword">tags:</span> tag1, tag2         <span class="comment"># Optional: labels for filtering</span></code></pre>

        <h3 id="transforms"><a href="#transforms" class="anchor-link">#</a>Transforms</h3>
        <p>Use <code>@transforms</code> at the top of <code>merchants.rules</code> to mutate fields before rule matching and reporting. Each line inside the block sets <code>field.&lt;name&gt;</code> to an expression. Built-ins <code>field.amount</code>, <code>field.description</code>, and <code>field.date</code> update the real transaction fields; other names go to <code>field</code> captures.</p>
        <pre><code><span class="highlight">@transforms</span>
<span class="comment"># Add fee column to amount (handles $ and commas)</span>
field.amount = field.amount + regex_replace(regex_replace(field.fee, <span class="string">"\\$"</span>, <span class="string">""</span>), <span class="string">","</span>, <span class="string">""</span>)

<span class="comment"># Clean descriptions</span>
field.description = regex_replace(field.description, <span class="string">"^APLPAY\\s+"</span>, <span class="string">""</span>)</code></pre>

        <h3>Example</h3>
        <pre><code><span class="highlight">[Netflix]</span>
<span class="keyword">match:</span> contains(<span class="string">"NETFLIX"</span>)
<span class="keyword">category:</span> Subscriptions
<span class="keyword">subcategory:</span> Streaming
<span class="keyword">tags:</span> entertainment, recurring

<span class="highlight">[Costco Grocery]</span>
<span class="keyword">match:</span> contains(<span class="string">"COSTCO"</span>) and amount &lt;= 200
<span class="keyword">category:</span> Food
<span class="keyword">subcategory:</span> Grocery

<span class="highlight">[Costco Bulk]</span>
<span class="keyword">match:</span> contains(<span class="string">"COSTCO"</span>) and amount &gt; 200
<span class="keyword">category:</span> Shopping
<span class="keyword">subcategory:</span> Wholesale</code></pre>

        <h2 id="match-functions"><a href="#match-functions" class="anchor-link">#</a>Match Functions</h2>
        <p>All match functions search <code>description</code> by default. Add an optional first argument to search a custom field.</p>

        <table>
            <tr>
                <th>Function</th>
                <th>Description</th>
            </tr>
            <tr>
                <td><code>contains("text")</code></td>
                <td>Case-insensitive substring match</td>
            </tr>
            <tr>
                <td><code>regex("pattern")</code></td>
                <td>Perl-compatible regex</td>
            </tr>
            <tr>
                <td><code>normalized("text")</code></td>
                <td>Ignores spaces, hyphens, punctuation</td>
            </tr>
            <tr>
                <td><code>anyof("a", "b", ...)</code></td>
                <td>Match any of multiple patterns</td>
            </tr>
            <tr>
                <td><code>startswith("text")</code></td>
                <td>Match only at beginning</td>
            </tr>
            <tr>
                <td><code>fuzzy("text")</code></td>
                <td>Approximate matching (80% similar)</td>
            </tr>
            <tr>
                <td><code>fuzzy("text", 0.90)</code></td>
                <td>Fuzzy with custom threshold</td>
            </tr>
        </table>

        <h3>Examples</h3>
        <pre><code><span class="comment"># Case-insensitive substring</span>
<span class="keyword">match:</span> contains(<span class="string">"NETFLIX"</span>)
<span class="comment"># Matches: NETFLIX.COM, netflix, Netflix Inc</span>

<span class="comment"># Regex with negative lookahead</span>
<span class="keyword">match:</span> regex(<span class="string">"UBER\\s(?!EATS)"</span>)
<span class="comment"># Matches: UBER TRIP, but not UBER EATS</span>

<span class="comment"># Ignore formatting differences</span>
<span class="keyword">match:</span> normalized(<span class="string">"WHOLEFOODS"</span>)
<span class="comment"># Matches: WHOLE FOODS, WHOLE-FOODS, WHOLEFDS</span>

<span class="comment"># Match multiple patterns</span>
<span class="keyword">match:</span> anyof(<span class="string">"NETFLIX"</span>, <span class="string">"HULU"</span>, <span class="string">"HBO"</span>)

<span class="comment"># Search custom field</span>
<span class="keyword">match:</span> contains(field.memo, <span class="string">"REF"</span>)</code></pre>

        <h2 id="conditions"><a href="#conditions" class="anchor-link">#</a>Amount &amp; Date Conditions</h2>
        <table>
            <tr>
                <th>Condition</th>
                <th>Description</th>
            </tr>
            <tr>
                <td><code>amount &gt; 100</code></td>
                <td>Transactions over $100</td>
            </tr>
            <tr>
                <td><code>amount &lt;= 50</code></td>
                <td>Transactions $50 or less</td>
            </tr>
            <tr>
                <td><code>amount &lt; 0</code></td>
                <td>Credits/refunds (negative amounts)</td>
            </tr>
            <tr>
                <td><code>month == 12</code></td>
                <td>December transactions only</td>
            </tr>
            <tr>
                <td><code>month &gt;= 11</code></td>
                <td>November and December</td>
            </tr>
            <tr>
                <td><code>year == 2024</code></td>
                <td>Specific year</td>
            </tr>
            <tr>
                <td><code>day == 1</code></td>
                <td>First of the month</td>
            </tr>
            <tr>
                <td><code>weekday == 0</code></td>
                <td>Mondays only (0=Mon, 1=Tue, ... 6=Sun)</td>
            </tr>
            <tr>
                <td><code>weekday &gt;= 5</code></td>
                <td>Weekends (Saturday=5, Sunday=6)</td>
            </tr>
            <tr>
                <td><code>date &gt;= "2024-01-01"</code></td>
                <td>On or after a specific date</td>
            </tr>
        </table>

        <h2 id="combining"><a href="#combining" class="anchor-link">#</a>Combining Conditions</h2>
        <table>
            <tr>
                <th>Operator</th>
                <th>Description</th>
                <th>Example</th>
            </tr>
            <tr>
                <td><code>and</code></td>
                <td>Both must be true</td>
                <td><code>contains("COSTCO") and amount &gt; 200</code></td>
            </tr>
            <tr>
                <td><code>or</code></td>
                <td>Either can be true</td>
                <td><code>contains("SHELL") or contains("CHEVRON")</code></td>
            </tr>
            <tr>
                <td><code>not</code></td>
                <td>Negates condition</td>
                <td><code>contains("UBER") and not contains("EATS")</code></td>
            </tr>
            <tr>
                <td><code>( )</code></td>
                <td>Group conditions</td>
                <td><code>(contains("AMAZON") or contains("AMZN")) and amount &gt; 100</code></td>
            </tr>
        </table>

        <h2 id="rule-mode"><a href="#rule-mode" class="anchor-link">#</a>Rule Mode (Experimental)</h2>
        <p>Control how rules are matched when multiple patterns could match a transaction.</p>

        <div class="note">
            <div class="note-title">Experimental</div>
            <p>This feature is experimental and may change based on feedback.</p>
        </div>

        <pre><code><span class="comment"># In settings.yaml:</span>
<span class="keyword">rule_mode:</span> first_match    <span class="comment"># Default - first matching rule wins</span>
<span class="keyword">rule_mode:</span> most_specific  <span class="comment"># Most specific pattern wins</span></code></pre>

        <h3>first_match (Default)</h3>
        <p>The first rule that matches wins. Order your rules from most specific to least specific:</p>
        <pre><code><span class="highlight">[Uber Eats]</span>                    <span class="comment"># Check first (more specific)</span>
<span class="keyword">match:</span> contains(<span class="string">"UBER EATS"</span>)
<span class="keyword">category:</span> Food

<span class="highlight">[Uber]</span>                         <span class="comment"># Check second (less specific)</span>
<span class="keyword">match:</span> contains(<span class="string">"UBER"</span>)
<span class="keyword">category:</span> Transportation</code></pre>

        <h3>most_specific</h3>
        <p>The rule with the most specific match wins, regardless of order. Specificity is determined by pattern length and type:</p>
        <pre><code><span class="comment"># Order doesn't matter with most_specific mode</span>
<span class="highlight">[Uber]</span>
<span class="keyword">match:</span> contains(<span class="string">"UBER"</span>)        <span class="comment"># Less specific (4 chars)</span>
<span class="keyword">category:</span> Transportation

<span class="highlight">[Uber Eats]</span>
<span class="keyword">match:</span> contains(<span class="string">"UBER EATS"</span>)   <span class="comment"># More specific (9 chars) - wins</span>
<span class="keyword">category:</span> Food</code></pre>

        <h2 id="custom-fields"><a href="#custom-fields" class="anchor-link">#</a>Custom CSV Fields</h2>
        <p>Access fields captured from CSV format strings using <code>field.&lt;name&gt;</code>:</p>
        <pre><code><span class="comment"># In settings.yaml:</span>
<span class="keyword">format:</span> <span class="string">"{date},{txn_type},{memo},{vendor},{amount}"</span>
<span class="keyword">columns:</span>
  <span class="keyword">description:</span> <span class="string">"{vendor}"</span>

<span class="comment"># In merchants.rules:</span>
<span class="highlight">[Wire Transfer]</span>
<span class="keyword">match:</span> field.txn_type == <span class="string">"WIRE"</span>
<span class="keyword">category:</span> Transfers

<span class="highlight">[Invoice Payment]</span>
<span class="keyword">match:</span> contains(field.memo, <span class="string">"Invoice"</span>)
<span class="keyword">category:</span> Bills</code></pre>

        <p>Use <code>exists(field.name)</code> to safely check if a field exists:</p>
        <pre><code><span class="keyword">match:</span> exists(field.memo) and contains(field.memo, <span class="string">"REF"</span>)</code></pre>

        <h2 id="extraction"><a href="#extraction" class="anchor-link">#</a>Extraction Functions</h2>
        <table>
            <tr>
                <th>Function</th>
                <th>Description</th>
            </tr>
            <tr>
                <td><code>extract("pattern")</code></td>
                <td>Extract first regex capture group</td>
            </tr>
            <tr>
                <td><code>split("-", 0)</code></td>
                <td>Split by delimiter, get element at index</td>
            </tr>
            <tr>
                <td><code>substring(0, 4)</code></td>
                <td>Extract substring by position</td>
            </tr>
            <tr>
                <td><code>trim()</code></td>
                <td>Remove leading/trailing whitespace</td>
            </tr>
            <tr>
                <td><code>exists(field.x)</code></td>
                <td>Check if field exists and is non-empty</td>
            </tr>
        </table>

        <h2 id="variables"><a href="#variables" class="anchor-link">#</a>Variables</h2>
        <p>Define reusable conditions at the top of your file:</p>
        <pre><code><span class="comment"># Define variables</span>
is_large = amount &gt; 500
is_holiday = month &gt;= 11 and month &lt;= 12
is_coffee = anyof(<span class="string">"STARBUCKS"</span>, <span class="string">"PEETS"</span>, <span class="string">"PHILZ"</span>)

<span class="comment"># Use in rules</span>
<span class="highlight">[Holiday Splurge]</span>
<span class="keyword">match:</span> is_large and is_holiday
<span class="keyword">category:</span> Shopping</code></pre>

        <h2 id="transforms"><a href="#transforms" class="anchor-link">#</a>Field Transforms</h2>
        <p>Mutate field values before matching. Place at the top of your file:</p>
        <pre><code><span class="comment"># Strip common prefixes</span>
field.description = regex_replace(field.description, <span class="string">"^APLPAY\\s+"</span>, <span class="string">""</span>)
field.description = regex_replace(field.description, <span class="string">"^SQ\\*\\s*"</span>, <span class="string">""</span>)
field.memo = trim(field.memo)</code></pre>

        <table>
            <tr>
                <th>Function</th>
                <th>Description</th>
            </tr>
            <tr>
                <td><code>regex_replace(text, pattern, repl)</code></td>
                <td>Regex substitution (replaces all matches)</td>
            </tr>
            <tr>
                <td><code>uppercase(text)</code></td>
                <td>Convert to uppercase</td>
            </tr>
            <tr>
                <td><code>lowercase(text)</code></td>
                <td>Convert to lowercase</td>
            </tr>
            <tr>
                <td><code>strip_prefix(text, prefix)</code></td>
                <td>Remove prefix (case-insensitive)</td>
            </tr>
            <tr>
                <td><code>strip_suffix(text, suffix)</code></td>
                <td>Remove suffix (case-insensitive)</td>
            </tr>
            <tr>
                <td><code>trim(text)</code></td>
                <td>Remove leading/trailing whitespace</td>
            </tr>
        </table>

        <div class="note">
            <div class="note-title">Note</div>
            <p>Original values are preserved in <code>_raw_&lt;field&gt;</code> (e.g., <code>_raw_description</code>).</p>
        </div>

        <h2 id="special-tags"><a href="#special-tags" class="anchor-link">#</a>Special Tags</h2>
        <p>These tags have special meaning in the spending report:</p>
        <table>
            <tr>
                <th>Tag</th>
                <th>Effect</th>
            </tr>
            <tr>
                <td><code>income</code></td>
                <td>Excluded from spending totals (salary, deposits)</td>
            </tr>
            <tr>
                <td><code>transfer</code></td>
                <td>Excluded from spending totals (CC payments, transfers)</td>
            </tr>
            <tr>
                <td><code>refund</code></td>
                <td>Shown in "Credits Applied" section, nets against spending</td>
            </tr>
        </table>

        <h2 id="dynamic-tags"><a href="#dynamic-tags" class="anchor-link">#</a>Dynamic Tags</h2>
        <p>Use <code>{expression}</code> to create tags from field values:</p>
        <pre><code><span class="highlight">[Bank Transaction]</span>
<span class="keyword">match:</span> contains(<span class="string">"BANK"</span>)
<span class="keyword">category:</span> Transfers
<span class="keyword">tags:</span> banking, {field.txn_type}     <span class="comment"># → "banking", "wire" or "ach"</span>

<span class="highlight">[All Purchases]</span>
<span class="keyword">match:</span> *
<span class="keyword">tags:</span> {source}                      <span class="comment"># → "alice-amex", "bob-chase", etc.</span></code></pre>

        <h2 id="tag-only-rules"><a href="#tag-only-rules" class="anchor-link">#</a>Tag-Only Rules</h2>
        <p>Rules without <code>category:</code> add tags without affecting categorization:</p>
        <pre><code><span class="highlight">[Large Purchase]</span>
<span class="keyword">match:</span> amount &gt; 500
<span class="keyword">tags:</span> large, review              <span class="comment"># No category - just adds tags</span>

<span class="highlight">[Holiday Season]</span>
<span class="keyword">match:</span> month &gt;= 11 and month &lt;= 12
<span class="keyword">tags:</span> holiday</code></pre>

        <div class="note">
            <div class="note-title">Two-pass matching</div>
            <p>First rule with <code>category:</code> sets the category. Tags are collected from tag-only rules plus the winning categorization rule.</p>
        </div>

        <h2 id="supplemental"><a href="#supplemental" class="anchor-link">#</a>Supplemental Data Sources (Experimental)</h2>
        <p>Enrich transactions with data from other CSV files. Match Amazon transactions to order details, PayPal payments to merchant names, or any cross-reference scenario.</p>

        <div class="note">
            <div class="note-title">Experimental</div>
            <p>This feature is experimental and will evolve based on feedback.</p>
        </div>

        <h3>Defining Supplemental Sources</h3>
        <pre><code><span class="comment"># In settings.yaml:</span>
<span class="keyword">data_sources:</span>
  - <span class="keyword">name:</span> Chase                    <span class="comment"># Primary source (generates transactions)</span>
    <span class="keyword">file:</span> data/chase.csv
    <span class="keyword">format:</span> <span class="string">"{date},{description},{amount}"</span>

  - <span class="keyword">name:</span> amazon_orders            <span class="comment"># Supplemental source (query-only)</span>
    <span class="keyword">file:</span> data/amazon_orders.csv
    <span class="keyword">format:</span> <span class="string">"{date},{item},{amount}"</span>
    <span class="keyword">supplemental:</span> true              <span class="comment"># Won't generate transactions</span></code></pre>

        <h3>Querying with List Comprehensions</h3>
        <p>Use Python list comprehensions to query supplemental data. Access the current transaction via <code>txn.</code>:</p>
        <pre><code><span class="highlight">[Amazon - Verified]</span>
<span class="keyword">match:</span> contains(<span class="string">"AMAZON"</span>) and any(r for r in amazon_orders if r.amount == txn.amount)
<span class="keyword">category:</span> Shopping
<span class="keyword">subcategory:</span> Online</code></pre>

        <h3>The let: Directive</h3>
        <p>Cache expensive queries in named variables for reuse:</p>
        <pre><code><span class="highlight">[Amazon - Verified]</span>
<span class="keyword">let:</span> orders = [r for r in amazon_orders if r.amount == txn.amount]
<span class="keyword">let:</span> has_order = len(orders) > 0
<span class="keyword">match:</span> contains(<span class="string">"AMAZON"</span>) and has_order
<span class="keyword">category:</span> Shopping
<span class="keyword">tags:</span> verified</code></pre>

        <h3>The field: Directive</h3>
        <p>Add computed fields to transactions (visible in HTML report):</p>
        <pre><code><span class="highlight">[Amazon - Verified]</span>
<span class="keyword">let:</span> orders = [r for r in amazon_orders if r.amount == txn.amount]
<span class="keyword">match:</span> contains(<span class="string">"AMAZON"</span>) and len(orders) > 0
<span class="keyword">category:</span> Shopping
<span class="keyword">field:</span> items = [r.item for r in orders]
<span class="keyword">field:</span> order_count = len(orders)</code></pre>

        <h3>Supported Functions</h3>
        <table>
            <tr>
                <th>Function</th>
                <th>Description</th>
            </tr>
            <tr>
                <td><code>any(expr for r in source if cond)</code></td>
                <td>True if any record matches</td>
            </tr>
            <tr>
                <td><code>len([...])</code></td>
                <td>Count of matching records</td>
            </tr>
            <tr>
                <td><code>sum(r.amount for r in source)</code></td>
                <td>Sum values from records</td>
            </tr>
            <tr>
                <td><code>next((r for r in source if cond), None)</code></td>
                <td>First matching record or None</td>
            </tr>
        </table>

        <h3>Transaction Context (txn.)</h3>
        <p>Access current transaction fields with the <code>txn.</code> prefix:</p>
        <table>
            <tr>
                <th>Field</th>
                <th>Description</th>
            </tr>
            <tr>
                <td><code>txn.amount</code></td>
                <td>Transaction amount</td>
            </tr>
            <tr>
                <td><code>txn.date</code></td>
                <td>Transaction date</td>
            </tr>
            <tr>
                <td><code>txn.description</code></td>
                <td>Transaction description</td>
            </tr>
            <tr>
                <td><code>txn.&lt;field&gt;</code></td>
                <td>Any custom captured field</td>
            </tr>
        </table>

        <h2 id="rule-priority"><a href="#rule-priority" class="anchor-link">#</a>Rule Priority</h2>
        <p>First categorization rule wins. Put specific patterns before general ones:</p>
        <pre><code><span class="highlight">[Uber Eats]</span>                    <span class="comment"># More specific, checked first</span>
<span class="keyword">match:</span> contains(<span class="string">"UBER EATS"</span>)
<span class="keyword">category:</span> Food

<span class="highlight">[Uber Rides]</span>                   <span class="comment"># Less specific, checked second</span>
<span class="keyword">match:</span> contains(<span class="string">"UBER"</span>)
<span class="keyword">category:</span> Transportation</code></pre>

        <h2 id="practical-examples"><a href="#practical-examples" class="anchor-link">#</a>Practical Examples</h2>

        <h3>Weekday vs Weekend Tagging</h3>
        <p>Tag the same merchant differently based on day of week (e.g., work lunches Monday-Friday):</p>
        <pre><code><span class="highlight">[Starbucks - Workdays]</span>
<span class="keyword">match:</span> contains(<span class="string">"Starbucks"</span>) and weekday &lt; 5  <span class="comment"># Monday-Friday (0-4)</span>
<span class="keyword">category:</span> Food
<span class="keyword">subcategory:</span> Coffee
<span class="keyword">tags:</span> work

<span class="highlight">[Starbucks]</span>
<span class="keyword">match:</span> contains(<span class="string">"Starbucks"</span>) and weekday &gt;= 5  <span class="comment"># Saturday-Sunday (5-6)</span>
<span class="keyword">category:</span> Food
<span class="keyword">subcategory:</span> Coffee
<span class="comment"># No work tag for weekends</span></code></pre>

        <h2 id="views-rules"><a href="#views-rules" class="anchor-link">#</a>Views Rules</h2>
        <p>File: <code>config/views.rules</code></p>
        <p>Create custom sections in the spending report.</p>

        <h3>View Structure</h3>
        <pre><code><span class="highlight">[View Name]</span>                <span class="comment"># Section header in report</span>
<span class="keyword">description:</span> &lt;text&gt;        <span class="comment"># Optional: subtitle under header</span>
<span class="keyword">filter:</span> &lt;expression&gt;       <span class="comment"># Required: which merchants to include</span></code></pre>

        <h3>Filter Primitives</h3>
        <table>
            <tr>
                <th>Name</th>
                <th>Type</th>
                <th>Description</th>
            </tr>
            <tr>
                <td><code>months</code></td>
                <td>int</td>
                <td>Number of months with transactions</td>
            </tr>
            <tr>
                <td><code>payments</code></td>
                <td>int</td>
                <td>Total number of transactions</td>
            </tr>
            <tr>
                <td><code>total</code></td>
                <td>float</td>
                <td>Total spending for this merchant</td>
            </tr>
            <tr>
                <td><code>cv</code></td>
                <td>float</td>
                <td>Coefficient of variation (0 = consistent)</td>
            </tr>
            <tr>
                <td><code>category</code></td>
                <td>str</td>
                <td>Merchant category</td>
            </tr>
            <tr>
                <td><code>subcategory</code></td>
                <td>str</td>
                <td>Merchant subcategory</td>
            </tr>
            <tr>
                <td><code>tags</code></td>
                <td>set</td>
                <td>Merchant tags (use <code>has</code> to check)</td>
            </tr>
        </table>

        <h2 id="view-functions"><a href="#view-functions" class="anchor-link">#</a>View Functions</h2>
        <table>
            <tr>
                <th>Function</th>
                <th>Description</th>
            </tr>
            <tr>
                <td><code>sum()</code>, <code>avg()</code>, <code>count()</code></td>
                <td>Aggregation functions</td>
            </tr>
            <tr>
                <td><code>min()</code>, <code>max()</code>, <code>stddev()</code></td>
                <td>Statistical functions</td>
            </tr>
            <tr>
                <td><code>by("month")</code></td>
                <td>Group transactions by month</td>
            </tr>
            <tr>
                <td><code>by("year")</code></td>
                <td>Group transactions by year</td>
            </tr>
        </table>

        <h3>Grouping with by()</h3>
        <pre><code><span class="comment"># Monthly grouping</span>
by(<span class="string">"month"</span>)              <span class="comment"># [[100, 200], [150], [175, 125]] - grouped payments</span>
sum(by(<span class="string">"month"</span>))         <span class="comment"># [300, 150, 300] - monthly totals</span>
avg(sum(by(<span class="string">"month"</span>)))    <span class="comment"># 250 - average monthly spend</span>
max(sum(by(<span class="string">"month"</span>)))    <span class="comment"># 300 - highest spending month</span></code></pre>

        <h3>View Examples</h3>
        <pre><code><span class="highlight">[Every Month]</span>
<span class="keyword">description:</span> Consistent recurring (rent, utilities, subscriptions)
<span class="keyword">filter:</span> months &gt;= 6 and cv &lt; 0.3

<span class="highlight">[Variable Recurring]</span>
<span class="keyword">description:</span> Frequent but inconsistent (groceries, shopping)
<span class="keyword">filter:</span> months &gt;= 6 and cv &gt;= 0.3

<span class="highlight">[Large Purchases]</span>
<span class="keyword">description:</span> Big one-time expenses
<span class="keyword">filter:</span> total &gt; 1000 and months &lt;= 2

<span class="highlight">[Business]</span>
<span class="keyword">description:</span> Expenses to submit for reimbursement
<span class="keyword">filter:</span> tags has <span class="string">"business"</span>

<span class="highlight">[Streaming]</span>
<span class="keyword">filter:</span> category == <span class="string">"Subscriptions"</span> and subcategory == <span class="string">"Streaming"</span></code></pre>

        <div class="note">
            <div class="note-title">Views vs Categories</div>
            <p><strong>Categories</strong> (in merchants.rules) define WHAT a transaction is. Each transaction has exactly one category.<br>
            <strong>Views</strong> (in views.rules) define HOW to group for reporting. Same merchant can appear in multiple views.</p>
        </div>
    </div>
</body>
</html>
