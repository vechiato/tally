name: Release

on:
  workflow_dispatch:
    inputs:
      use_existing_notes:
        description: 'Keep the AI-generated notes from the draft release'
        required: false
        type: boolean
        default: true
      release_notes:
        description: 'Release notes (ignored if use_existing_notes is true)'
        required: false
        type: string
        default: ''

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout (for gh CLI context)
        uses: actions/checkout@v4

      - name: Find latest draft release
        id: draft
        run: |
          DRAFT=$(gh release list --json tagName,isDraft \
            -q '[.[] | select(.isDraft)] | .[0].tagName')
          if [ -z "$DRAFT" ] || [ "$DRAFT" = "null" ]; then
            echo "::error::No draft release found! Push to main first to create a release candidate."
            exit 1
          fi
          echo "tag=$DRAFT" >> $GITHUB_OUTPUT
          echo "Found draft release: $DRAFT"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Get draft release info
        id: info
        run: |
          SHA=$(gh release view ${{ steps.draft.outputs.tag }} \
            --json targetCommitish -q '.targetCommitish')
          echo "sha=$SHA" >> $GITHUB_OUTPUT
          echo "Commit: $SHA"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Verify E2E passed
        run: |
          echo "Checking latest E2E status on main branch..."

          # Get the latest E2E run on main branch
          STATUS=$(gh run list \
            --branch main \
            --workflow "E2E Smoke Test" \
            --json conclusion,status \
            --limit 1 \
            -q '.[0].conclusion')

          echo "E2E conclusion: $STATUS"

          if [ "$STATUS" != "success" ]; then
            echo "::error::E2E tests did not pass on main branch"
            echo "Status was: $STATUS"
            echo ""
            echo "The release candidate cannot be published until E2E tests pass."
            exit 1
          fi
          echo "E2E tests passed!"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Build release body
        env:
          USE_EXISTING: ${{ inputs.use_existing_notes }}
          RELEASE_NOTES: ${{ inputs.release_notes }}
          TAG: ${{ steps.draft.outputs.tag }}
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get the release notes content
          if [ "$USE_EXISTING" = "true" ]; then
            echo "Using existing notes from draft release..."
            # Fetch existing draft body and extract content before the --- separator
            EXISTING=$(gh release view "$TAG" --json body -q '.body')
            # Extract everything up to the --- line (the AI notes section)
            NOTES_CONTENT=$(echo "$EXISTING" | sed '/^---$/,$d' | sed '/^[[:space:]]*$/d')
            if [ -n "$NOTES_CONTENT" ]; then
              echo "Found existing notes"
            else
              echo "No existing notes found, will use minimal body"
            fi
          else
            echo "Using provided release notes..."
            if [ -n "$RELEASE_NOTES" ]; then
              NOTES_CONTENT="## What's Changed

          $RELEASE_NOTES"
            else
              NOTES_CONTENT=""
            fi
          fi

          # Build final body with install instructions
          {
            if [ -n "$NOTES_CONTENT" ]; then
              echo "$NOTES_CONTENT"
              echo ""
              echo "---"
              echo ""
            fi
            echo "### Install"
            echo ""
            echo "**Linux / macOS:**"
            echo '```bash'
            echo "curl -fsSL https://tallyai.money/install.sh | bash"
            echo '```'
            echo ""
            echo "**Windows PowerShell:**"
            echo '```powershell'
            echo "irm https://tallyai.money/install.ps1 | iex"
            echo '```'
            echo ""
            echo "Or download the zip for your platform below."
            echo ""
            echo "See https://tallyai.money for more info."
          } > body.md

          echo "Release body:"
          cat body.md

      - name: Publish release
        run: |
          gh release edit ${{ steps.draft.outputs.tag }} \
            --title "Tally ${{ steps.draft.outputs.tag }}" \
            --notes-file body.md \
            --draft=false \
            --latest
          echo ""
          echo "Published ${{ steps.draft.outputs.tag }} as latest release!"
          echo "View at: https://github.com/${{ github.repository }}/releases/tag/${{ steps.draft.outputs.tag }}"
        env:
          GH_TOKEN: ${{ github.token }}
