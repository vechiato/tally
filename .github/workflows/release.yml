name: Release

on:
  workflow_dispatch:
    inputs:
      release_notes:
        description: 'Release notes (what changed in this release)'
        required: false
        type: string
        default: ''

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Find latest draft release
        id: draft
        run: |
          DRAFT=$(gh release list --json tagName,isDraft \
            -q '[.[] | select(.isDraft)] | .[0].tagName')
          if [ -z "$DRAFT" ] || [ "$DRAFT" = "null" ]; then
            echo "::error::No draft release found! Push to main first to create a release candidate."
            exit 1
          fi
          echo "tag=$DRAFT" >> $GITHUB_OUTPUT
          echo "Found draft release: $DRAFT"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Get draft release info
        id: info
        run: |
          SHA=$(gh release view ${{ steps.draft.outputs.tag }} \
            --json targetCommitish -q '.targetCommitish')
          echo "sha=$SHA" >> $GITHUB_OUTPUT
          echo "Commit: $SHA"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Verify E2E passed
        run: |
          echo "Checking E2E status for commit ${{ steps.info.outputs.sha }}..."

          STATUS=$(gh run list \
            --commit ${{ steps.info.outputs.sha }} \
            --workflow "E2E Smoke Test" \
            --json conclusion \
            -q '.[0].conclusion')

          echo "E2E conclusion: $STATUS"

          if [ "$STATUS" != "success" ]; then
            echo "::error::E2E tests did not pass for commit ${{ steps.info.outputs.sha }}"
            echo "Status was: $STATUS"
            echo ""
            echo "The release candidate cannot be published until E2E tests pass."
            exit 1
          fi
          echo "E2E tests passed!"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Build release body
        env:
          RELEASE_NOTES: ${{ inputs.release_notes }}
        run: |
          {
            if [ -n "$RELEASE_NOTES" ]; then
              echo "## What's Changed"
              echo ""
              echo "$RELEASE_NOTES"
              echo ""
              echo "---"
              echo ""
            fi
            echo "### Install"
            echo ""
            echo "**Linux / macOS:**"
            echo '```bash'
            echo "curl -fsSL https://tallyai.money/install.sh | bash"
            echo '```'
            echo ""
            echo "**Windows PowerShell:**"
            echo '```powershell'
            echo "irm https://tallyai.money/install.ps1 | iex"
            echo '```'
            echo ""
            echo "Or download the zip for your platform below."
            echo ""
            echo "See https://tallyai.money for more info."
          } > body.md

          echo "Release body:"
          cat body.md

      - name: Publish release
        run: |
          gh release edit ${{ steps.draft.outputs.tag }} \
            --title "Tally ${{ steps.draft.outputs.tag }}" \
            --notes-file body.md \
            --draft=false \
            --latest
          echo ""
          echo "Published ${{ steps.draft.outputs.tag }} as latest release!"
          echo "View at: https://github.com/${{ github.repository }}/releases/tag/${{ steps.draft.outputs.tag }}"
        env:
          GH_TOKEN: ${{ github.token }}
