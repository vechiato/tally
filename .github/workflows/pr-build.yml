name: PR Build

on:
  pull_request_target:
    branches: [main]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to build'
        required: true
        type: number

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      pr_number: ${{ steps.pr.outputs.number }}
      head_sha: ${{ steps.pr.outputs.sha }}
      short_sha: ${{ steps.pr.outputs.short_sha }}
      version: ${{ steps.pr.outputs.version }}
    steps:
      - name: Get PR info
        id: pr
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            PR_NUMBER="${{ inputs.pr_number }}"
            PR_DATA=$(gh api repos/${{ github.repository }}/pulls/$PR_NUMBER)
            HEAD_SHA=$(echo "$PR_DATA" | jq -r '.head.sha')
          else
            PR_NUMBER="${{ github.event.pull_request.number }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          fi
          SHORT_SHA="${HEAD_SHA:0:7}"
          VERSION="0.0.${PR_NUMBER}-${SHORT_SHA}"

          echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "sha=$HEAD_SHA" >> $GITHUB_OUTPUT
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

  build:
    needs: prepare
    uses: ./.github/workflows/build.yml
    with:
      version: ${{ needs.prepare.outputs.version }}
      git_sha: ${{ needs.prepare.outputs.head_sha }}
      ref: ${{ needs.prepare.outputs.head_sha }}

  comment:
    needs: [prepare, build]
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - name: Build comment body
        run: |
          PR_NUMBER="${{ needs.prepare.outputs.pr_number }}"
          RUN_ID="${{ github.run_id }}"
          SHORT_SHA="${{ needs.prepare.outputs.short_sha }}"

          cat > comment.md << 'EOF'
          ## PR Build Available

          Version: `0.0.PR_NUMBER-SHORT_SHA`

          ### Install from this PR

          **Linux / macOS:**
          ```bash
          curl -fsSL https://raw.githubusercontent.com/REPO/main/docs/install-pr.sh | bash -s -- PR_NUMBER
          ```

          **Windows PowerShell:**
          ```powershell
          iex "& { $(irm https://raw.githubusercontent.com/REPO/main/docs/install-pr.ps1) } PR_NUMBER"
          ```

          **Manual download:** [View workflow run](https://github.com/REPO/actions/runs/RUN_ID) and download artifacts.

          <details>
          <summary>Requirements</summary>

          - GitHub CLI (`gh`) must be installed and authenticated
          - Run `gh auth login` if not already authenticated

          </details>
          EOF

          # Replace placeholders
          sed -i "s/PR_NUMBER/${PR_NUMBER}/g" comment.md
          sed -i "s/SHORT_SHA/${SHORT_SHA}/g" comment.md
          sed -i "s|REPO|${{ github.repository }}|g" comment.md
          sed -i "s/RUN_ID/${RUN_ID}/g" comment.md

          cat comment.md

      - name: Find existing comment
        uses: peter-evans/find-comment@v3
        id: find
        with:
          issue-number: ${{ needs.prepare.outputs.pr_number }}
          comment-author: 'github-actions[bot]'
          body-includes: '## PR Build Available'

      - name: Create or update comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.find.outputs.comment-id }}
          issue-number: ${{ needs.prepare.outputs.pr_number }}
          body-path: comment.md
          edit-mode: replace
