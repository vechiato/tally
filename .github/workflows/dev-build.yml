name: Dev Build

on:
  push:
    branches: [main]

jobs:
  # Run tests first - gate the build
  tests:
    uses: ./.github/workflows/test.yml

  prepare:
    needs: [tests]
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - id: version
        run: echo "version=0.1.$(git rev-list --count HEAD)" >> $GITHUB_OUTPUT

  # Build dev version
  build-dev:
    needs: prepare
    uses: ./.github/workflows/build.yml
    with:
      version: ${{ needs.prepare.outputs.version }}-dev
      git_sha: ${{ github.sha }}

  # Build RC version (same commit, stable version number)
  build-rc:
    needs: prepare
    uses: ./.github/workflows/build.yml
    with:
      version: ${{ needs.prepare.outputs.version }}
      git_sha: ${{ github.sha }}

  # Generate release notes with AI (optional - only if auth is configured)
  generate-notes:
    needs: [prepare, build-rc]
    uses: ./.github/workflows/generate-release-notes.yml
    with:
      version: ${{ needs.prepare.outputs.version }}
    secrets:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

  release:
    needs: [prepare, build-dev, build-rc, generate-notes]
    if: ${{ always() && needs.build-dev.result == 'success' && needs.build-rc.result == 'success' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      # Download dev artifacts
      - name: Download dev artifacts
        uses: actions/download-artifact@v4
        with:
          path: dev-artifacts
          pattern: tally-*-dev
          merge-multiple: false

      # Download RC artifacts
      - name: Download RC artifacts
        uses: actions/download-artifact@v4
        with:
          path: rc-artifacts
          pattern: tally-*-rc
          merge-multiple: false

      - name: List artifacts
        run: |
          echo "Dev artifacts:"
          find dev-artifacts -type f
          echo ""
          echo "RC artifacts:"
          find rc-artifacts -type f

      # Delete old dev release and create new one
      - name: Create dev release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ needs.prepare.outputs.version }}
          SHA: ${{ github.sha }}
        run: |
          gh release delete dev --cleanup-tag --yes || true

          cat > notes.md << EOF
          Latest build from main branch

          **Version:** ${VERSION}-dev
          **Commit:** ${SHA}

          ### Install

          **Update existing installation:**
          \`\`\`bash
          tally update --prerelease
          \`\`\`

          **Linux / macOS:**
          \`\`\`bash
          curl -fsSL https://tallyai.money/install.sh | bash -s -- --prerelease
          \`\`\`

          **Windows PowerShell:**
          \`\`\`powershell
          iex "& { \$(irm https://tallyai.money/install.ps1) } -Prerelease"
          \`\`\`

          Or download the zip for your platform below.
          EOF

          gh release create dev \
            --title "Development Build (${VERSION}-dev)" \
            --notes-file notes.md \
            --prerelease \
            dev-artifacts/*/*.zip

      # Delete old draft releases and create new one
      - name: Create draft RC release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ needs.prepare.outputs.version }}
          SHA: ${{ github.sha }}
          AI_NOTES: ${{ needs.generate-notes.outputs.notes }}
        run: |
          # Delete any existing drafts
          for tag in $(gh release list --json tagName,isDraft -q '.[] | select(.isDraft) | .tagName'); do
            echo "Deleting draft release: $tag"
            gh release delete "$tag" --yes || true
          done

          # Use AI-generated notes if available, otherwise use default
          if [ -n "$AI_NOTES" ]; then
            echo "Using AI-generated release notes"
            cat > notes.md << EOF
          ## What's Changed

          ${AI_NOTES}

          ---

          **Commit:** ${SHA}
          **E2E Status:** Pending...
          EOF
          else
            echo "No AI notes available, using default"
            cat > notes.md << EOF
          Release candidate - pending publish

          **Commit:** ${SHA}
          **E2E Status:** Pending...
          EOF
          fi

          # Create new draft
          gh release create "v${VERSION}" \
            --title "Tally v${VERSION}" \
            --notes-file notes.md \
            --draft \
            rc-artifacts/*/*.zip
