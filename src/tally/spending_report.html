<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Financial Report</title>
    <style>/* CSS_PLACEHOLDER */</style>
</head>
<body>
    <div id="app">
        <div class="container">
            <!-- Header -->
            <header>
                <h1 data-testid="report-title">{{ title }}</h1>
                <p class="subtitle">{{ subtitle }}</p>
                <button class="theme-toggle" data-testid="theme-toggle" @click="toggleTheme" :title="isDarkTheme ? 'Switch to light mode' : 'Switch to dark mode'">
                    {{ isDarkTheme ? '‚òÄÔ∏è' : 'üåô' }}
                </button>
            </header>

            <!-- Search & Filters -->
            <div class="search-box" :class="{ scrolled: isScrolled }">
                <div class="autocomplete-container">
                    <input type="text"
                           v-model="searchQuery"
                           @input="onSearchInput"
                           @focus="showAutocomplete = true"
                           @keydown="onSearchKeydown"
                           placeholder="Search merchants, categories, locations...">
                    <div class="autocomplete-list" :class="{ show: showAutocomplete && filteredAutocomplete.length > 0 }">
                        <div v-for="(item, index) in filteredAutocomplete"
                             :key="item.id"
                             class="autocomplete-item"
                             :class="{ selected: index === autocompleteIndex }"
                             @click="selectAutocompleteItem(item)">
                            {{ item.displayText }}
                            <span class="type" :class="item.type">{{ item.type }}</span>
                        </div>
                    </div>
                </div>
                <select class="date-range-select" @change="addMonthFilter($event.target.value); $event.target.value = ''">
                    <option value="">+ Date filter</option>
                    <optgroup label="Individual Months">
                        <option v-for="m in availableMonths" :key="m.key" :value="m.key">{{ m.label }}</option>
                    </optgroup>
                </select>
                <div class="filter-chips" v-if="activeFilters.length > 0" data-testid="filter-chips">
                    <div v-for="(filter, index) in activeFilters"
                         :key="index"
                         class="filter-chip"
                         :class="[filter.type, filter.mode]"
                         data-testid="filter-chip"
                         @click="toggleFilterMode(index)">
                        <span class="chip-type">{{ filterTypeChar(filter.type) }}</span>
                        <span class="chip-text">{{ filter.displayText || filter.text }}</span>
                        <span class="chip-remove" data-testid="filter-chip-remove" @click.stop="removeFilter(index)">&times;</span>
                    </div>
                    <button v-if="activeFilters.length > 1" class="clear-all-btn" data-testid="clear-filters" @click="clearFilters">Clear all</button>
                </div>
            </div>

            <!-- Summary Cards -->
            <div class="summary-grid">
                <div class="card cashflow" data-testid="cashflow-card">
                    <h2>Cash Flow</h2>
                    <div class="amount" data-testid="cashflow-amount" :class="{ positive: cashFlow >= 0, negative: cashFlow < 0 }">
                        {{ cashFlow >= 0 ? '+' : '' }}{{ formatCurrency(cashFlow) }}
                    </div>
                    <div class="breakdown">
                        <div class="breakdown-item clickable" @click="addFilter('income', 'tag')">
                            <span class="name income-label">Income</span>
                            <span class="value">+{{ formatCurrency(incomeTotal) }}</span>
                        </div>
                        <div class="breakdown-item">
                            <span class="name">Spending</span>
                            <span class="value">-{{ formatCurrency(spendingTotal) }}</span>
                        </div>
                        <div class="breakdown-item" v-if="dataCreditsTotal > 0">
                            <span class="name">Credits</span>
                            <span class="value">+{{ formatCurrency(dataCreditsTotal) }}</span>
                        </div>
                    </div>
                </div>
                <div class="card investment" data-testid="investment-card" v-if="investmentTotal > 0">
                    <h2>Investments</h2>
                    <div class="amount">
                        {{ formatCurrency(investmentTotal) }}
                    </div>
                    <div class="breakdown">
                        <div class="breakdown-item clickable" @click="addFilter('investment', 'tag')">
                            <span class="name">401K, IRA, etc.</span>
                            <span class="value">{{ formatCurrency(investmentTotal) }}</span>
                        </div>
                    </div>
                </div>
                <div class="card filtered-spending" data-testid="filtered-spending-card">
                    <h2>Filtered View</h2>
                    <div class="amount" data-testid="filtered-amount" :class="{ positive: filteredViewTotals.hasIncome && filteredViewTotals.net >= 0 }">
                        {{ filteredViewTotals.hasIncome && filteredViewTotals.net >= 0 ? '+' : '' }}{{ formatCurrency(filteredViewTotals.net) }}
                    </div>
                    <div class="breakdown">
                        <div class="breakdown-item" v-if="filteredViewTotals.income > 0">
                            <span class="name income-label">Income</span>
                            <span class="value">+{{ formatCurrency(filteredViewTotals.income) }}</span>
                        </div>
                        <div class="breakdown-item" v-if="filteredViewTotals.spending > 0">
                            <span class="name">Spending</span>
                            <span class="value">{{ formatCurrency(filteredViewTotals.spending) }}</span>
                        </div>
                        <div class="breakdown-item" v-if="filteredViewTotals.credits > 0">
                            <span class="name">Credits</span>
                            <span class="value">+{{ formatCurrency(filteredViewTotals.credits) }}</span>
                        </div>
                        <div class="breakdown-item" v-if="filteredViewTotals.investment > 0">
                            <span class="name">Investment</span>
                            <span class="value">{{ formatCurrency(filteredViewTotals.investment) }}</span>
                        </div>
                        <div class="breakdown-item" v-if="filteredViewTotals.transfers !== 0">
                            <span class="name">Transfers</span>
                            <span class="value">{{ filteredViewTotals.transfers >= 0 ? '+' : '' }}{{ formatCurrency(filteredViewTotals.transfers) }}</span>
                        </div>
                        <div class="breakdown-item">
                            <span class="name">Transactions</span>
                            <span class="value">{{ filteredViewTotals.count.toLocaleString() }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="chart-section">
                <div class="section-header" @click="chartsCollapsed = !chartsCollapsed">
                    <h2>
                        <span class="toggle">{{ chartsCollapsed ? '‚ñ∂' : '‚ñº' }}</span>
                        Transaction Trends
                    </h2>
                </div>
                <div class="section-content" :class="{ collapsed: chartsCollapsed }">
                    <div class="charts-grid">
                        <div class="chart-container">
                            <h3>Monthly Trend</h3>
                            <div class="chart-wrapper">
                                <canvas ref="monthlyChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-container">
                            <h3>By Category</h3>
                            <div class="chart-wrapper">
                                <canvas ref="categoryPieChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="chart-container" style="margin-top: 2rem;">
                        <h3>Category Trends by Month</h3>
                        <div class="chart-wrapper" style="height: 350px;">
                            <canvas ref="categoryByMonthChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- View Toggle -->
            <div class="view-toggle" v-if="hasSections">
                <button :class="{ active: currentView === 'category' }" @click="currentView = 'category'">
                    By Category
                </button>
                <button :class="{ active: currentView === 'section' }" @click="currentView = 'section'">
                    By View
                </button>
            </div>

            <!-- Section View -->
            <template v-if="currentView === 'section' && hasSections">
                <merchant-section
                    v-for="(section, sectionId) in filteredSectionView"
                    :key="sectionId"
                    :section-key="'sec:' + sectionId"
                    :title="section.title"
                    :items="Object.values(section.filteredMerchants)"
                    :total-amount="section.filteredTotal"
                    :category-total="section.filteredTotal"
                    :grand-total="grandTotal"
                    :gross-spending="grossSpending"
                    :num-months="numFilteredMonths"
                    :category-mode="true"
                    :collapsed-sections="collapsedSections"
                    :sort-config="sortConfig"
                    :expanded-items="expandedMerchants"
                    :extra-field-matches="extraFieldMatches"
                    :toggle-section="toggleSection"
                    :toggle-sort="toggleSort"
                    :format-currency="formatCurrency"
                    :format-date="formatDate"
                    :format-pct="formatPct"
                    :add-filter="addFilter"
                    :get-location-class="getLocationClass"
                    :highlight-description="highlightDescription"
                    :tag-color="tagColor"
                ></merchant-section>
            </template>

            <!-- Category View -->
            <template v-if="currentView === 'category'">
                <merchant-section
                    v-for="(category, categoryName) in positiveCategoryView"
                    :key="categoryName"
                    :section-key="'cat:' + categoryName"
                    :title="categoryName"
                    :items="category.sortedMerchants"
                    :total-amount="category.filteredTotal"
                    :category-total="category.filteredTotal"
                    :grand-total="grandTotal"
                    :gross-spending="grossSpending"
                    :income-total="incomeTotal"
                    :investment-total="investmentTotal"
                    :type-totals="category.typeTotals"
                    :num-months="numFilteredMonths"
                    :header-color="categoryColorMap[categoryName]"
                    :category-mode="true"
                    :collapsed-sections="collapsedSections"
                    :sort-config="sortConfig"
                    :expanded-items="expandedMerchants"
                    :extra-field-matches="extraFieldMatches"
                    :toggle-section="toggleSection"
                    :toggle-sort="toggleSort"
                    :format-currency="formatCurrency"
                    :format-date="formatDate"
                    :format-pct="formatPct"
                    :add-filter="addFilter"
                    :get-location-class="getLocationClass"
                    :highlight-description="highlightDescription"
                    :tag-color="tagColor"
                ></merchant-section>
            </template>

            <!-- Credits Section (refunds/credits that reduced spending) -->
            <merchant-section
                v-if="creditMerchants.length > 0"
                section-key="credits"
                title="Credits Applied"
                :items="creditMerchants"
                :show-total="true"
                :total-amount="creditsTotal"
                total-label="Total Credits"
                subtitle="(reduced spending)"
                :credit-mode="true"
                :collapsed-sections="collapsedSections"
                :sort-config="sortConfig"
                :expanded-items="expandedMerchants"
                :extra-field-matches="extraFieldMatches"
                :toggle-section="toggleSection"
                :toggle-sort="toggleSort"
                :format-currency="formatCurrency"
                :format-date="formatDate"
                :add-filter="addFilter"
                :highlight-description="highlightDescription"
                :tag-color="tagColor"
            ></merchant-section>

            <!-- Footer -->
            <footer>
                <p>Generated by tally &middot; Data through {{ spendingData.dataThrough || 'present' }}</p>
            </footer>
        </div>
    </div>

    <!-- Dependencies -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Data (injected by Python) -->
    <script>/* DATA_PLACEHOLDER */</script>

    <!-- Vue App -->
    <script>/* JS_PLACEHOLDER */</script>
</body>
</html>
