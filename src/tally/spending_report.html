<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Spending Report</title>
    <style>/* CSS_PLACEHOLDER */</style>
</head>
<body>
    <div id="app">
        <div class="container">
            <!-- Header -->
            <header>
                <h1 data-testid="report-title">{{ title }}</h1>
                <p class="subtitle">{{ subtitle }}</p>
                <button class="theme-toggle" data-testid="theme-toggle" @click="toggleTheme" :title="isDarkTheme ? 'Switch to light mode' : 'Switch to dark mode'">
                    {{ isDarkTheme ? '‚òÄÔ∏è' : 'üåô' }}
                </button>
            </header>

            <!-- Search & Filters -->
            <div class="search-box" :class="{ scrolled: isScrolled }">
                <div class="autocomplete-container">
                    <input type="text"
                           v-model="searchQuery"
                           @input="onSearchInput"
                           @focus="showAutocomplete = true"
                           @keydown="onSearchKeydown"
                           placeholder="Search merchants, categories, locations...">
                    <div class="autocomplete-list" :class="{ show: showAutocomplete && filteredAutocomplete.length > 0 }">
                        <div v-for="(item, index) in filteredAutocomplete"
                             :key="item.id"
                             class="autocomplete-item"
                             :class="{ selected: index === autocompleteIndex }"
                             @click="selectAutocompleteItem(item)">
                            {{ item.displayText }}
                            <span class="type" :class="item.type">{{ item.type }}</span>
                        </div>
                    </div>
                </div>
                <select class="date-range-select" @change="addMonthFilter($event.target.value); $event.target.value = ''">
                    <option value="">+ Date filter</option>
                    <optgroup label="Individual Months">
                        <option v-for="m in availableMonths" :key="m.key" :value="m.key">{{ m.label }}</option>
                    </optgroup>
                </select>
                <div class="filter-chips" v-if="activeFilters.length > 0" data-testid="filter-chips">
                    <div v-for="(filter, index) in activeFilters"
                         :key="index"
                         class="filter-chip"
                         :class="[filter.type, filter.mode]"
                         data-testid="filter-chip"
                         @click="toggleFilterMode(index)">
                        <span class="chip-type">{{ filterTypeChar(filter.type) }}</span>
                        <span class="chip-text">{{ filter.displayText || filter.text }}</span>
                        <span class="chip-remove" data-testid="filter-chip-remove" @click.stop="removeFilter(index)">&times;</span>
                    </div>
                    <button v-if="activeFilters.length > 1" class="clear-all-btn" data-testid="clear-filters" @click="clearFilters">Clear all</button>
                </div>
            </div>

            <!-- Help Section -->
            <div class="help-section" :class="{ collapsed: helpCollapsed }">
                <div class="help-section-header" @click="helpCollapsed = !helpCollapsed">
                    <h3>How to Read This Report</h3>
                    <span class="toggle">{{ helpCollapsed ? '‚ñ∂' : '‚ñº' }}</span>
                </div>
                <div class="help-section-content">
                    <span class="label">Categories:</span>
                    <span class="value">Merchants are grouped by their assigned category from merchant_categories.csv</span>
                    <span class="label">Terms:</span>
                    <span class="value"><code>YTD</code> year-to-date total ¬∑ <code>Count</code> number of transactions</span>
                    <span class="label">Filters:</span>
                    <span class="value">Click on categories, tags, or locations to filter. Use search to find specific merchants.</span>
                </div>
            </div>

            <!-- Summary Cards -->
            <div class="summary-grid">
                <div class="card total" data-testid="total-spending-card">
                    <h2>Total Spending (YTD)</h2>
                    <div class="amount" data-testid="total-spending-amount">{{ formatCurrency(grandTotal) }}</div>
                    <div class="breakdown">
                        <div class="breakdown-item" v-if="creditsTotal > 0">
                            <span class="name credit-label">Credits Applied</span>
                            <span class="value">+{{ formatCurrency(creditsTotal) }}</span>
                        </div>
                        <div class="breakdown-item" v-if="uncategorizedTotal > 0">
                            <span class="name">Uncategorized</span>
                            <span class="value">{{ formatCurrency(uncategorizedTotal) }} ({{ formatPct(uncategorizedTotal, grandTotal) }})</span>
                        </div>
                    </div>
                </div>
                <!-- Cash Flow card - show when there's income -->
                <div class="card cashflow" v-if="incomeCount > 0" data-testid="cashflow-card">
                    <h2>Cash Flow</h2>
                    <div class="amount" data-testid="cashflow-amount" :class="{ positive: netCashFlow >= 0, negative: netCashFlow < 0 }">
                        {{ netCashFlow >= 0 ? '+' : '' }}{{ formatCurrency(netCashFlow) }}
                    </div>
                    <div class="breakdown">
                        <div class="breakdown-item clickable" @click="addFilter('income', 'tag')">
                            <span class="name income-label">Income</span>
                            <span class="value" data-testid="income-amount">+{{ formatCurrency(Math.abs(incomeTotal)) }}</span>
                        </div>
                        <div class="breakdown-item">
                            <span class="name">Spending</span>
                            <span class="value" data-testid="spending-in-cashflow">-{{ formatCurrency(grandTotal) }}</span>
                        </div>
                        <div class="breakdown-item clickable" v-if="transfersCount > 0" @click="addFilter('transfer', 'tag')">
                            <span class="name transfers-label">Transfers</span>
                            <span class="value" data-testid="transfers-amount">{{ formatCurrency(Math.abs(transfersTotal)) }}</span>
                        </div>
                    </div>
                </div>
                <!-- Excluded card - show when there are excluded but no income -->
                <div class="card excluded-summary" v-else-if="filteredExcludedCount > 0" data-testid="excluded-card">
                    <h2>Excluded</h2>
                    <div class="amount" data-testid="excluded-total">{{ formatCurrency(excludedTotal) }}</div>
                    <div class="breakdown">
                        <div class="breakdown-item clickable" data-testid="show-excluded-link" @click="scrollToExcluded">
                            <span class="name">Not included in spending</span>
                            <span class="value" data-testid="excluded-count">{{ filteredExcludedCount }} transactions</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="chart-section">
                <div class="section-header" @click="chartsCollapsed = !chartsCollapsed">
                    <h2>
                        <span class="toggle">{{ chartsCollapsed ? '‚ñ∂' : '‚ñº' }}</span>
                        Spending Trends
                    </h2>
                </div>
                <div class="section-content" :class="{ collapsed: chartsCollapsed }">
                    <div class="charts-grid">
                        <div class="chart-container">
                            <h3>Monthly Spending Trend</h3>
                            <div class="chart-wrapper">
                                <canvas ref="monthlyChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-container">
                            <h3>Spending by Category</h3>
                            <div class="chart-wrapper">
                                <canvas ref="categoryPieChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="chart-container" style="margin-top: 2rem;">
                        <h3>Category Trends by Month</h3>
                        <div class="chart-wrapper" style="height: 350px;">
                            <canvas ref="categoryByMonthChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- View Toggle -->
            <div class="view-toggle" v-if="hasSections">
                <button :class="{ active: currentView === 'category' }" @click="currentView = 'category'">
                    By Category
                </button>
                <button :class="{ active: currentView === 'section' }" @click="currentView = 'section'">
                    By View
                </button>
            </div>

            <!-- Section View -->
            <template v-if="currentView === 'section' && hasSections">
                <merchant-section
                    v-for="(section, sectionId) in filteredSectionView"
                    :key="sectionId"
                    :section-key="'sec:' + sectionId"
                    :title="section.title"
                    :items="Object.values(section.filteredMerchants)"
                    :total-amount="section.filteredTotal"
                    :category-total="section.filteredTotal"
                    :grand-total="grandTotal"
                    :gross-spending="grossSpending"
                    :num-months="numFilteredMonths"
                    :category-mode="true"
                    :collapsed-sections="collapsedSections"
                    :sort-config="sortConfig"
                    :expanded-items="expandedMerchants"
                    :toggle-section="toggleSection"
                    :toggle-sort="toggleSort"
                    :format-currency="formatCurrency"
                    :format-date="formatDate"
                    :format-pct="formatPct"
                    :add-filter="addFilter"
                    :get-location-class="getLocationClass"
                    :highlight-description="highlightDescription"
                    :tag-color="tagColor"
                ></merchant-section>
            </template>

            <!-- Category View -->
            <template v-if="currentView === 'category'">
                <merchant-section
                    v-for="(category, categoryName) in positiveCategoryView"
                    :key="categoryName"
                    :section-key="'cat:' + categoryName"
                    :title="categoryName"
                    :items="category.sortedMerchants"
                    :total-amount="category.filteredTotal"
                    :category-total="category.filteredTotal"
                    :grand-total="grandTotal"
                    :gross-spending="grossSpending"
                    :num-months="numFilteredMonths"
                    :header-color="categoryColorMap[categoryName]"
                    :category-mode="true"
                    :collapsed-sections="collapsedSections"
                    :sort-config="sortConfig"
                    :expanded-items="expandedMerchants"
                    :toggle-section="toggleSection"
                    :toggle-sort="toggleSort"
                    :format-currency="formatCurrency"
                    :format-date="formatDate"
                    :format-pct="formatPct"
                    :add-filter="addFilter"
                    :get-location-class="getLocationClass"
                    :highlight-description="highlightDescription"
                    :tag-color="tagColor"
                ></merchant-section>
            </template>

            <!-- Credits Section (refunds/credits that reduced spending) -->
            <merchant-section
                v-if="creditMerchants.length > 0"
                section-key="credits"
                title="Credits Applied"
                :items="creditMerchants"
                :show-total="true"
                :total-amount="creditsTotal"
                total-label="Total Credits"
                subtitle="(reduced spending)"
                :credit-mode="true"
                :collapsed-sections="collapsedSections"
                :sort-config="sortConfig"
                :expanded-items="expandedMerchants"
                :toggle-section="toggleSection"
                :toggle-sort="toggleSort"
                :format-currency="formatCurrency"
                :format-date="formatDate"
                :add-filter="addFilter"
                :highlight-description="highlightDescription"
                :tag-color="tagColor"
            ></merchant-section>

            <!-- Excluded Section -->
            <merchant-section
                v-if="groupedExcluded.length > 0"
                section-key="excluded"
                title="Excluded"
                :items="groupedExcluded"
                subtitle="(not included in spending)"
                :collapsed-sections="collapsedSections"
                :sort-config="sortConfig"
                :expanded-items="expandedExcluded"
                :toggle-section="toggleSection"
                :toggle-sort="toggleSort"
                :format-currency="formatCurrency"
                :format-date="formatDate"
                :add-filter="addFilter"
                :highlight-description="highlightDescription"
                :tag-color="tagColor"
            ></merchant-section>

            <!-- Footer -->
            <footer>
                <p>Generated by tally &middot; Data through {{ spendingData.dataThrough || 'present' }}</p>
            </footer>
        </div>
    </div>

    <!-- Dependencies -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Data (injected by Python) -->
    <script>/* DATA_PLACEHOLDER */</script>

    <!-- Vue App -->
    <script>/* JS_PLACEHOLDER */</script>
</body>
</html>
